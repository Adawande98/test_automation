name: PIH Release Automation

on:
  workflow_dispatch:
    inputs:
      release_branch:
        description: "Enter release branch name (e.g. release/v1.2.3)"
        required: true

  push:
    branches:
      - "release/*"

permissions:
  contents: write
  pull-requests: write

jobs:
  Automated-Release:
    name: Automated Release Pipeline
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------
      # STEP 1: Checkout
      # -------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------------------------------
      # STEP 2: Extract release branch + version
      # -------------------------------------------------------
      - name: Determine release branch and version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BRANCH="${{ github.event.inputs.release_branch }}"
          else
            BRANCH=${GITHUB_REF#refs/heads/}
          fi

          VERSION=${BRANCH#release/}

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "Detected Branch: $BRANCH"
          echo "Detected Version: $VERSION"

      # -------------------------------------------------------
      # STEP 3: Load PR Template
      # -------------------------------------------------------
      - name: Load PR Template
        id: template
        run: |
          TEMPLATE=""
          
          # Check multiple possible template locations
          if [ -f ".github/pull_request_template.md" ]; then
            TEMPLATE=".github/pull_request_template.md"
          elif [ -f ".github/PULL_REQUEST_TEMPLATE/pull_request_template.md" ]; then
            TEMPLATE=".github/PULL_REQUEST_TEMPLATE/pull_request_template.md"
          elif [ -f ".github/PULL_REQUEST_TEMPLATE.md" ]; then
            TEMPLATE=".github/PULL_REQUEST_TEMPLATE.md"
          else
            echo "❌ ERROR: No PR template found!"
            exit 1
          fi

          echo "template<<EOF" >> $GITHUB_OUTPUT
          cat "$TEMPLATE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "Loaded template file: $TEMPLATE"

      # -------------------------------------------------------
      # STEP 4: Create PR release → main
      # -------------------------------------------------------
      - name: Create Pull Request to main
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          head: ${{ steps.version.outputs.branch }}   # release/x.y.z
          base: main
          title: "Release ${{ steps.version.outputs.version }} → main"
          body: "${{ steps.template.outputs.template }}"
          labels: release

      # -------------------------------------------------------
      # STEP 5: Create PR release → develop
      # -------------------------------------------------------
      - name: Create Pull Request to develop
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          head: ${{ steps.version.outputs.branch }}   # release/x.y.z
          base: develop
          title: "Release ${{ steps.version.outputs.version }} → develop"
          body: "${{ steps.template.outputs.template }}"
          labels: release
