name: PIH Release Automation

on:
  workflow_dispatch:
    inputs:
      release_branch:
        description: "Enter release branch name (e.g. release/v1.2.3)"
        required: true
  push:
    branches:
      - "release/*"

permissions:
  contents: write
  pull-requests: write

jobs:
  Automated-Release:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------
      # STEP 1: Checkout
      # -------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------------------------------
      # STEP 2: Determine release branch + version
      # -------------------------------------------------------
      - name: Determine release branch and version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BRANCH_NAME="${{ github.event.inputs.release_branch }}"
          else
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          fi

          VERSION="${BRANCH_NAME#release/}"

          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # -------------------------------------------------------
      # STEP 3: Load Template and Apply Summary Logic
      # -------------------------------------------------------
      - name: Load PR Template With Dynamic Summary
        id: template
        run: |
          TEMPLATE=$(cat .github/pull_request_template.md)

          # summary placeholder replaced per PR creation
          echo "template=$TEMPLATE" >> $GITHUB_OUTPUT

      # -------------------------------------------------------
      # STEP 4: Create PR release → main
      # -------------------------------------------------------
      - name: Create PR to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SUMMARY="This PR merges changes from '${{ steps.version.outputs.branch }}' into 'main'."
          
          BODY="${{ steps.template.outputs.template }}"
          BODY="${BODY//\{\{SUMMARY_PLACEHOLDER\}\}/$SUMMARY}"

          gh pr create \
            --head "${{ steps.version.outputs.branch }}" \
            --base "main" \
            --title "Release ${{ steps.version.outputs.version }} → main" \
            --body "$BODY" || echo "PR already exists or cannot be created."

      # -------------------------------------------------------
      # STEP 5: Create PR release → develop
      # -------------------------------------------------------
      - name: Create PR to develop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SUMMARY="This PR merges changes from '${{ steps.version.outputs.branch }}' into 'develop'."
          
          BODY="${{ steps.template.outputs.template }}"
          BODY="${BODY//\{\{SUMMARY_PLACEHOLDER\}\}/$SUMMARY}"

          gh pr create \
            --head "${{ steps.version.outputs.branch }}" \
            --base "develop" \
            --title "Release ${{ steps.version.outputs.version }} → develop" \
            --body "$BODY" || echo "PR already exists or cannot be created."
